<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Quiz des Herzens</title>

<style>
body { margin:0; height:100vh; background:#0f0f0f; overflow:hidden; font-family:Arial,Helvetica,sans-serif; color:#fff; display:flex; justify-content:center; align-items:center; }
.hearts { position:fixed; width:100%; height:100%; overflow:hidden; z-index:0; }
.heart-bg { position:absolute; bottom:-50px; font-size:30px; color:rgba(255,80,80,0.25); animation:floatUp linear infinite; }
@keyframes floatUp { from { transform:translateY(0); } to { transform:translateY(-120vh); } }

.card { width:420px; padding:30px; border-radius:25px; border:3px solid #c62828; background:#1a1a1a; text-align:center; box-shadow:0 0 25px rgba(198,40,40,0.4); position:relative; z-index:2; margin:0 auto; transition:border-color 0.3s; }
#heart-container { position:relative; height:80px; margin-bottom:15px; z-index:2; }
#heart { font-size:70px; color:#ff4d4d; animation:pulse 1s infinite; }
@keyframes pulse {0% {transform:scale(1);}50%{transform:scale(1.2);}100%{transform:scale(1);} }

.course { font-size:14px; letter-spacing:1px; color:#ff6b6b; margin-bottom:8px; }
h1 { margin:5px 0; font-size:28px; }
.subtitle { font-size:14px; color:#cccccc; margin-bottom:25px; }

label { display:block; margin-bottom:8px; color:#ff5252; font-size:16px; }
input { width:80%; padding:10px; border-radius:12px; border:none; outline:none; font-size:16px; text-align:center; margin-bottom:20px; }

button { padding:12px 30px; border-radius:20px; border:none; font-size:16px; background:#c62828; color:white; cursor:pointer; }
button:hover { background:#e53935; }

.question-container { display:none; flex-direction:column; text-align:center; }

/* ‚úÖ Frage-Z√§hler (klein, ausgegraut) */
.q-progress{
  font-size:12px;
  color:#9a9a9a;
  margin-bottom:6px;
  letter-spacing:0.3px;
}

.question-text { font-size:18px; margin-bottom:16px; }

/* ‚úÖ Antworten sauber untereinander + gleiche Gr√∂√üe */
.answers-wrap{
  display:flex;
  flex-direction:column;
  gap:10px;
  width:100%;
}

.answer-btn{
  width:100%;
  box-sizing:border-box;
  background:#333;
  color:white;
  border:none;
  border-radius:12px;
  padding:12px 12px;
  cursor:pointer;
  font-size:16px;
  transition:0.3s;
  text-align:center;
  min-height:46px;
}
.answer-btn:hover { background:#555; }

.correct { background-color:#4CAF50 !important; }
.wrong { background-color:#f44336 !important; }

.feedback { margin-top:15px; font-size:16px; min-height:20px; }

/* Kapitel 2 L√ºckentext */
#chapter2-container { display:none; flex-direction:column; text-align:left; max-height:500px; overflow-y:auto; margin-top:20px; }
#chapter2-text { background:#1a1a1a; padding:15px; border-radius:15px; border:2px solid #c62828; }
.luecke {
  display:inline-flex; justify-content:center; align-items:center;
  min-width:110px; height:32px; padding:4px 8px; margin:4px 4px;
  border:2px solid #c62828; border-radius:8px;
  background:#111; color:#fff; font-weight:bold;
  cursor:pointer;
}
.luecke:hover { background:#222; }

.luecke.good{
  border-color:#4CAF50 !important;
  background:#0f1b12 !important;
}
.luecke.bad{
  border-color:#f44336 !important;
  background:#1b0f0f !important;
}
.luecke.locked{
  cursor:default;
  opacity:0.95;
}

.wordbank { margin-top:15px; }
.wordbank span { background:#c62828; padding:5px 10px; border-radius:12px; margin:4px; cursor:pointer; display:inline-block; }
.wordbank span.selected { background:#4CAF50; }
.wordbank span.disabled { opacity:0.45; cursor:default; }

#reset-btn, #chapter2-next-btn { margin-top:15px; padding:10px 20px; border-radius:15px; border:none; cursor:pointer; background:#c62828; color:white; }
#reset-btn:hover, #chapter2-next-btn:hover { background:#e53935; }

#chapter2-feedback{
  margin-top:12px;
  min-height:18px;
  font-size:14px;
  color:#cccccc;
}

/* Kapitel 3: Risikomodus */
#risk-entry, #risk-container{
  display:none;
  flex-direction:column;
  text-align:center;
  max-height:520px;
  overflow-y:auto;
  margin-top:12px;
}

.risk-box{
  background:#141414;
  border:2px solid #c62828;
  border-radius:18px;
  padding:14px;
  text-align:left;
  margin-top:10px;
}

.risk-title{
  font-size:22px;
  margin:4px 0 8px;
  color:#ff2020;
  text-shadow:0 0 10px rgba(255,32,32,0.35);
  letter-spacing:0.3px;
}

.risk-small{
  font-size:13px;
  color:#cccccc;
  line-height:1.35;
}

.risk-stats{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.risk-pill{
  padding:8px 10px;
  border-radius:14px;
  background:#1f1f1f;
  border:1px solid rgba(198,40,40,0.55);
  font-size:13px;
  color:#fff;
}

.risk-actions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:14px;
  flex-wrap:wrap;
}
.risk-actions button{
  padding:10px 18px;
  border-radius:18px;
  font-size:15px;
}

.btn-secondary{
  background:#333 !important;
}
.btn-secondary:hover{
  background:#444 !important;
}

.risk-level-title{
  margin-top:10px;
  font-size:16px;
  color:#ffb3b3;
}

.risk-area{
  margin-top:12px;
  text-align:left;
}

.risk-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}

.match-col{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.match-item{
  background:#222;
  border:1px solid rgba(198,40,40,0.55);
  border-radius:12px;
  padding:10px 10px;
  cursor:pointer;
  text-align:center;
  user-select:none;
}
.match-item:hover{ background:#2b2b2b; }

.match-item.selected{
  outline:2px solid #4CAF50;
  background:#1d2b1f;
}
.match-item.done{
  opacity:0.55;
  cursor:default;
}

.risk-note{
  margin-top:10px;
  min-height:18px;
  font-size:14px;
  color:#cccccc;
}

.order-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:10px;
}
.order-row{
  display:flex;
  gap:8px;
  align-items:center;
}
.order-row select{
  flex:1;
  background:#111;
  color:#fff;
  border:1px solid rgba(198,40,40,0.55);
  border-radius:12px;
  padding:10px;
  font-size:14px;
  outline:none;
}

.letters-wrap{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.letter-btn{
  background:#222;
  border:1px solid rgba(198,40,40,0.55);
  color:#fff;
  border-radius:12px;
  padding:10px 12px;
  cursor:pointer;
  user-select:none;
}
.letter-btn:disabled{
  opacity:0.55;
  cursor:default;
}
.letter-btn.used{
  background:#c62828 !important;
  border-color:#ff5252 !important;
  color:#fff !important;
  opacity:1 !important;
}

/* ‚úÖ Level 6: Tasten verschwinden ohne Verschieben */
.letter-btn.vanish{
  visibility:hidden !important;
  pointer-events:none !important;
}

.letters-progress{
  margin-top:10px;
  font-size:16px;
  letter-spacing:2px;
  background:#111;
  border:1px solid rgba(198,40,40,0.55);
  border-radius:12px;
  padding:10px 12px;
}

/* Ergebnisseite */
#result-page { display:none; flex-direction:column; text-align:center; max-height:400px; overflow-y:auto; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ffff00; padding:10px; text-align:center; }
th { background:#c62828; color:#fff; }
.table-wrap{ max-height:300px; overflow-y:auto; margin-top:20px; border-radius:12px; }

/* ‚úÖ eigenen Rang hervorheben */
tr.me-row td{
  background:rgba(76, 175, 80, 0.18);
  font-weight:bold;
}
tr.me-row td:first-child{
  border-left:3px solid #4CAF50;
}

/* ‚úÖ Custom Modal f√ºr Name (ersetzt alert) */
#nameModalOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.72);
  justify-content:center;
  align-items:center;
  z-index:9999;
}
#nameModal{
  background:#1a1a1a;
  border:2px solid #c62828;
  border-radius:20px;
  padding:22px 18px;
  width:85%;
  max-width:360px;
  box-shadow:0 0 25px rgba(198,40,40,0.35);
  text-align:center;
}
#nameModal p{
  margin:0;
  color:#fff;
  font-size:16px;
  line-height:1.35;
}
#nameModalOk{
  margin-top:14px;
  padding:10px 26px;
  border-radius:20px;
  border:none;
  background:#c62828;
  color:#fff;
  cursor:pointer;
  font-size:16px;
}
#nameModalOk:hover{ background:#e53935; }

/* ‚úÖ Punkteanzeige (immer sichtbar im Basic-Quiz bis Risiko) */
#scoreBoard{
  position:fixed;
  top:15px;
  right:20px;
  background:#1a1a1a;
  border:2px solid #c62828;
  padding:8px 14px;
  border-radius:14px;
  font-weight:bold;
  color:#fff;
  box-shadow:0 0 14px rgba(198,40,40,0.35);
  z-index:99999;
  display:none; /* wird beim Start eingeblendet */
}
</style>
</head>

<body>
<div class="hearts" id="hearts"></div>

<!-- ‚úÖ Scoreboard -->
<div id="scoreBoard">Punkte: <span id="scoreValue">0</span></div>

<div class="card" id="card">
  <div id="heart-container"><div id="heart">‚ù§Ô∏è</div></div>

  <!-- Start -->
  <div id="start-page">
    <div class="course">Kurs: F25</div>
    <h1>Quiz des Herzens</h1>
    <div class="subtitle">von Robin Gulikers und Justin Hebben</div>
    <label for="name">Wie hei√üt du?</label>
    <input type="text" id="name" placeholder="Vor- und Nachname">
    <button id="start-btn">Start</button>
  </div>

  <!-- Kapitel 1 -->
  <div id="quiz-container" class="question-container">
    <div id="qProgress" class="q-progress"></div>
    <div id="question" class="question-text"></div>

    <div class="answers-wrap">
      <button class="answer-btn" id="answer0"></button>
      <button class="answer-btn" id="answer1"></button>
      <button class="answer-btn" id="answer2"></button>
      <button class="answer-btn" id="answer3"></button>
    </div>

    <div class="feedback" id="feedback"></div>
    <button id="next-btn" style="display:none;margin-top:15px;">N√§chste Frage</button>
  </div>

  <!-- Kapitel 2 -->
  <div id="chapter2-container">
    <div id="chapter2-text"></div>
    <div class="wordbank" id="wordbank"></div>
    <button id="reset-btn">Zur√ºcksetzen</button>
    <button id="chapter2-next-btn">Weiter</button>
    <div id="chapter2-feedback"></div>
  </div>

  <!-- Kapitel 3: Einstieg Risikomodus -->
  <div id="risk-entry">
    <div class="risk-title">Risikomodus</div>
    <div class="risk-box">
      <div class="risk-small">
        Du kannst jetzt freiwillig in den <b>Risikomodus</b> gehen.<br><br>
        ‚úÖ Du sammelst <b>Zusatzpunkte</b> in einem eigenen Risiko-Topf.<br>
        ‚ùå <b>Ein Fehler</b> oder <b>Timer abgelaufen</b> = Risiko-Topf wird <b>0</b>.<br><br>
        Deine bisherigen Punkte bleiben in jedem Fall sicher.
      </div>
      <div class="risk-stats" style="margin-top:12px;">
        <div class="risk-pill">Level 1: +20</div>
        <div class="risk-pill">Level 2: +20</div>
        <div class="risk-pill">Level 3: +40</div>
        <div class="risk-pill">Level 4: +80</div>
        <div class="risk-pill">Level 5: +160</div>
        <div class="risk-pill">Level 6: +320</div>
      </div>
    </div>

    <div class="risk-actions">
      <button id="risk-start-btn">Risikomodus starten</button>
      <button id="risk-skip-btn" class="btn-secondary">Direkt zur Rangliste</button>
    </div>
    <div class="risk-note" id="risk-entry-note"></div>
  </div>

  <!-- Kapitel 3: Risikomodus -->
  <div id="risk-container">
    <div class="risk-title">Risikomodus</div>

    <div class="risk-stats">
      <div class="risk-pill" id="riskBasePill">Basis: 0</div>
      <div class="risk-pill" id="riskPotPill">Risiko-Topf: 0</div>
      <div class="risk-pill" id="riskLevelPill">Level: 1/6</div>
      <div class="risk-pill" id="riskTimerPill">‚è±Ô∏è 0s</div>
    </div>

    <div class="risk-level-title" id="riskLevelTitle">Level 1</div>

    <div class="risk-area" id="riskArea"></div>

    <div class="risk-actions">
      <button id="risk-action-btn">Level betreten</button>
      <button id="risk-cashout-btn" class="btn-secondary" style="display:none;">Aufh√∂ren & Punkte mitnehmen</button>
    </div>

    <div class="risk-note" id="risk-note"></div>
  </div>

  <!-- Ergebnis -->
  <div id="result-page">
    <h1>Rangliste</h1>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Name</th><th>Punkte</th></tr></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚úÖ Custom Modal (ersetzt das Browser-Fenster) -->
<div id="nameModalOverlay">
  <div id="nameModal" role="dialog" aria-modal="true" aria-labelledby="nameModalText">
    <p id="nameModalText">Du sollst Vor‚Äì und Nachnamen eingeben</p>
    <button id="nameModalOk">OK</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGQhJ8LDyK-yqG11IVbv8EDE8bHYOBJIU",
  authDomain: "quiz-des-herzens.firebaseapp.com",
  projectId: "quiz-des-herzens",
  storageBucket: "quiz-des-herzens.firebasestorage.app",
  messagingSenderId: "700084611111",
  appId: "1:700084611111:web:e7c630697e80fffe8cc602"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===============================
// Scoreboard (Basic bis Risiko)
// ===============================
const scoreBoard = document.getElementById("scoreBoard");
const scoreValue = document.getElementById("scoreValue");

function getDisplayedPoints(){
  // Kapitel 1: mcScore z√§hlt live (je 10 Punkte)
  // Kapitel 2 (vor Auswertung): weiterhin mcScore * 10
  // Nach Kapitel 2 Auswertung: baseScore (berechnet)
  // Risiko: baseScore bleibt sichtbar (HUD zeigt zus√§tzlich Risiko-Topf)
  if(baseScore > 0) return baseScore;
  return (mcScore * 10);
}

function updateScoreDisplay(){
  scoreValue.textContent = String(getDisplayedPoints());
}

function showScoreboard(){
  scoreBoard.style.display = "block";
  updateScoreDisplay();
}

function hideScoreboard(){
  scoreBoard.style.display = "none";
}

// ===============================
// Name / Alias / Device
// ===============================
const DEVICE_ID_KEY = "heartQuiz_deviceId_v1";

function normalizeSpaces(str){ return (str || "").trim().replace(/\s+/g, " "); }
function normalizeName(str){ return normalizeSpaces(str).toLocaleLowerCase("de-DE"); }

function isValidFullName(str){
  const cleaned = normalizeSpaces(str);
  const parts = cleaned.split(" ").filter(Boolean);
  return parts.length >= 2 && parts[0].length >= 2 && parts[1].length >= 2;
}

function toTitleCaseName(str){
  const cleaned = normalizeSpaces(str);
  return cleaned.split(" ").filter(Boolean)
    .map(w => w.charAt(0).toLocaleUpperCase("de-DE") + w.slice(1).toLocaleLowerCase("de-DE"))
    .join(" ");
}

// ‚úÖ Alias (case-insensitive)
function resolveDisplayName(rawName){
  const norm = normalizeName(rawName);
  if(norm === "gina neumann") return "Gina‚ÄìMarie Neumann";
  return toTitleCaseName(rawName);
}

function getOrCreateDeviceId(){
  let id = localStorage.getItem(DEVICE_ID_KEY);
  if(!id){
    id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    localStorage.setItem(DEVICE_ID_KEY, id);
  }
  return id;
}

/* ‚úÖ Custom Modal Steuerung (statt alert) */
const nameModalOverlay = document.getElementById("nameModalOverlay");
const nameModalOk = document.getElementById("nameModalOk");

function openNameModal(){
  nameModalOverlay.style.display = "flex";
}
function closeNameModal(){
  nameModalOverlay.style.display = "none";
}

nameModalOk.addEventListener("click", closeNameModal);
nameModalOverlay.addEventListener("click", (e)=>{
  if(e.target === nameModalOverlay) closeNameModal();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && nameModalOverlay.style.display === "flex") closeNameModal();
});

/* ‚úÖ Helfer: Array mischen (Fisher-Yates) */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// ===============================
// Firestore Ranking (pro Ger√§t bester Versuch)
// ===============================
async function saveScoreToFirestore(rawName, points){
  const name = resolveDisplayName(rawName);
  const deviceId = getOrCreateDeviceId();

  const newPoints = Number(points) || 0;
  const ref = doc(db, "ranking", deviceId);

  // ‚úÖ Nur speichern, wenn besser als bisher (oder noch kein Eintrag existiert)
  try{
    const existingSnap = await getDoc(ref);
    if(existingSnap.exists()){
      const old = existingSnap.data() || {};
      const oldPoints = Number(old.points) || 0;

      if(newPoints <= oldPoints){
        return;
      }
    }
  }catch(e){
    console.log("Firestore Read (best score) warn:", e);
  }

  await setDoc(ref, {
    deviceId,
    name,
    points: newPoints,
    createdAt: Date.now()
  }, { merge: true });
}

async function loadRankingFromFirestore(){
  const qy = query(collection(db, "ranking"), orderBy("points", "desc"));
  const snap = await getDocs(qy);

  const bestByDevice = new Map();
  snap.forEach(docu=>{
    const d = docu.data();
    if(!d || !d.deviceId) return;

    const existing = bestByDevice.get(d.deviceId);
    if(!existing || (d.points||0) > (existing.points||0)){
      bestByDevice.set(d.deviceId, { deviceId: d.deviceId, name: d.name || "Unbekannt", points: d.points || 0 });
    }
  });

  const arr = Array.from(bestByDevice.values());
  arr.sort((a,b)=> (b.points||0) - (a.points||0));
  return arr.slice(0, 50);
}

async function renderRanking(){
  const tbody = document.getElementById("ranking-body");
  tbody.innerHTML = "<tr><td colspan='3'>Lade Rangliste‚Ä¶</td></tr>";

  try{
    const ranking = await loadRankingFromFirestore();
    tbody.innerHTML = "";

    if(ranking.length === 0){
      tbody.innerHTML = "<tr><td colspan='3'>Noch keine Eintr√§ge.</td></tr>";
      return;
    }

    const myDeviceId = getOrCreateDeviceId();

    ranking.forEach((entry, idx)=>{
      const tr = document.createElement("tr");
      if(entry.deviceId === myDeviceId) tr.classList.add("me-row");
      tr.innerHTML = `<td>${idx+1}</td><td>${entry.name}</td><td>${entry.points}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.log(e);
    tbody.innerHTML = "<tr><td colspan='3'>Fehler beim Laden (Firestore).</td></tr>";
  }
}

// ===============================
// Hintergrund-Herzen
// ===============================
const heartsContainer = document.getElementById("hearts");
let bgHearts = [];
for(let i=0;i<25;i++){
  const h=document.createElement("div");
  h.className="heart-bg";
  h.innerHTML="‚ù§Ô∏è";
  h.style.left=Math.random()*100+"vw";
  h.style.animationDuration=(6+Math.random()*6)+"s";
  h.style.fontSize=(20+Math.random()*30)+"px";
  h.style.animationDelay=Math.random()*5+"s";
  heartsContainer.appendChild(h);
  bgHearts.push(h);
}

// ===============================
// Kapitel 1: Multiple Choice (20)
// ===============================
const quiz = [
  {q:"Welche Kammer des Herzens pumpt Blut in den Lungenkreislauf?",a:["Linker Vorhof","Rechter Vorhof","Linke Kammer","Rechte Kammer"],correct:3},
  {q:"Was ist die Hauptaufgabe der Arterien?",a:["Sie transportieren sauerstoffreiches Blut zum Herzen","Sie transportieren Blut vom Herzen weg zu den Organen und Geweben","Sie transportieren sauerstoffarmes Blut zum Herzen","Sie transportieren Blut innerhalb der Organe"],correct:1},
  {q:"Welche Funktion hat das Herzklappen‚ÄìSystem?",a:["Es speichert Blut","Es produziert Sauerstoff","Es macht eigentlich gar nichts","Es verhindert R√ºckfluss von Blut"],correct:3},
  {q:"Welche Blutgef√§√üe bringen Blut zum Herzen?",a:["Arterien","Venen","Kapillaren","Aorta"],correct:1},
  {q:"Was ist eine h√§ufige Ursache f√ºr eine erh√∂hte Herzfrequenz?",a:["Schlaf","Entspannung","Stress","Meditation"],correct:2},
  {q:"Welche Struktur trennt die linke von der rechten Herzh√§lfte?",a:["Herzklappen","Kapillaren","Myokard","Septum"],correct:3},
  {q:"Was ist die Aufgabe der Lungenvenen?",a:["Sie transportieren sauerstoffarmes Blut zum Herzen","Sie transportieren sauerstoffreiches Blut zum Herzen","Sie transportieren sauerstoffarmes Blut vom Herzen weg","Sie transportieren sauerstoffreiches Blut vom Herzen weg"],correct:1},
  {q:"Was ist die Aufgabe der Segelklappen?",a:["Sie leiten das Blut in die Arterien","Sie speichern Blut","Sie verhindern den R√ºckfluss von Blut aus den Kammern in die Vorh√∂fe","Sie verhindern den R√ºckfluss von Blut aus den Vorh√∂fe in die Kammern"],correct:2},
  {q:"Welche Struktur ist ma√ügeblich f√ºr die schnelle Weiterleitung des elektrischen Impulses in den Herzkammern verantwortlich?",a:["Purkinje‚ÄìFasern","His‚ÄìB√ºndel","Sinusknoten","Kapillaren"],correct:0},
  {q:"Was ist die Aufgabe der Taschenklappen?",a:["Sie verhindern den R√ºckfluss von Blut aus den Kammern in die Vorh√∂fe","Sie regulieren den Blutdruck in den Vorh√∂fen","Sie verhindern den R√ºckfluss von Blut aus den Arterien in die Kammern","Sie verhindern den R√ºckfluss von Blut aus den Kammern in die Arterien"],correct:2},
  {q:"Was sind die kleinsten Blutgef√§√üe in unserem K√∂rper?",a:["Koronararterien","Purkinje‚ÄìFasern","Venen","Kapillaren"],correct:3},
  {q:"Wie hoch ist der physiologische Ruhepuls eines gesunden Erwachsenen?",a:["30‚Äì40 Schl√§ge pro Minute","60‚Äì80 Schl√§ge pro Minute","90‚Äì110 Schl√§ge pro Minute","√ºber 120 Schl√§ge pro Minute"],correct:1},
  {q:"Welche Herzklappe befindet sich zwischen linker Vorhof und linker Kammer?",a:["Mitralklappe","Trikuspidalklappe","Aortenklappe","Pulmonalklappe"],correct:0},
  {q:"Welche Aufgabe hat die Aorta?",a:["Blut in den K√∂rperkreislauf transportieren","Blut in die Lunge transportieren","Blut zur√ºck zum Herzen bringen","Blut speichern"],correct:0},
  {q:"Welche Zellen des Herzens sind f√ºr die Erzeugung des elektrischen Impulses verantwortlich?",a:["Purkinje-Fasern","Cellulae pacemaker","Kapillaren","Myozyten"],correct:1},
  {q:"Wie gro√ü ist das menschliche Herz ungef√§hr?",a:["So gro√ü wie ein Apfel","So gro√ü wie ein Fu√üball","So gro√ü wie die eigene Faust","So gro√ü wie ein Tennisball"],correct:2},
  {q:"Wo liegt das Herz im K√∂rper?",a:["Links im Brustkorb direkt unter der Lunge","Mittig im Bauchraum","Im Mediastinum hinter dem Brustbein, leicht nach links verschoben","Direkt unter dem Zwerchfell"],correct:2},
  {q:"Welche Phase bezeichnet die Kontraktion der Herzkammern?",a:["Diastole","Systole","Depolarisation","Repolarisation"],correct:1},
  {q:"Wie viel Blut pumpt das Herz ungef√§hr pro Schlag (Schlagvolumen) beim Erwachsenen in Ruhe?",a:["ca. 10‚Äì20 ml","ca. 30‚Äì40 ml","ca. 70 ml","ca. 200 ml"],correct:2},
  {q:"Welche Struktur bestimmt normalerweise den Herzrhythmus?",a:["AV-Knoten","His-B√ºndel","Purkinje-Fasern","Sinusknoten"],correct:3}
];

let currentQuestion=0;
let mcScore=0;
let lueckenScore=0;

// Scores
let baseScore = 0;  // Basis nach Kapitel 1 + 2
let riskScore = 0;  // Risikomodus-Topf
let finalScore = 0; // Basis + Risiko
let savedOnce = false;

const heart=document.getElementById("heart");
const card=document.getElementById("card");
const startPage=document.getElementById("start-page");
const quizContainer=document.getElementById("quiz-container");
const qProgress=document.getElementById("qProgress");
const questionText=document.getElementById("question");
const feedback=document.getElementById("feedback");
const nextBtn=document.getElementById("next-btn");
const answerButtons=[
  document.getElementById("answer0"),
  document.getElementById("answer1"),
  document.getElementById("answer2"),
  document.getElementById("answer3")
];

const rightEmojis=["üòç","ü•∞","ü§©","ü•≥","üòé","üëè","üëç","üòá","üòä","üéâ","ü§ó"];
const wrongEmojis=["ü•≤","üòë","üò°","üôÑ","ü§ï","üí©","üíÄ","ü§°","ü§¶üèª‚Äç‚ôÇÔ∏è","üòí","üíî"];

// Start
document.getElementById("start-btn").addEventListener("click", ()=>{
  const rawInput = document.getElementById("name").value;
  const name = normalizeSpaces(rawInput);
  if(!isValidFullName(name)){
    openNameModal();
    return;
  }

  // ‚úÖ Reset f√ºr neuen Run + Scoreboard an
  currentQuestion = 0;
  mcScore = 0;
  lueckenScore = 0;
  baseScore = 0;
  riskScore = 0;
  finalScore = 0;
  savedOnce = false;

  localStorage.setItem("playerName", name);
  startPage.style.display="none";
  quizContainer.style.display="flex";

  showScoreboard();
  updateScoreDisplay();

  showQuestion();
});

document.getElementById("name").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") document.getElementById("start-btn").click();
});

function showQuestion(){
  const q = quiz[currentQuestion];
  qProgress.textContent = `Frage ${currentQuestion+1}/${quiz.length}`;
  questionText.textContent = q.q;
  feedback.textContent="";
  nextBtn.style.display="none";

  heart.textContent="‚ù§Ô∏è";
  heart.style.animation="pulse 1s infinite";
  card.style.borderColor="#c62828";
  bgHearts.forEach(h=>h.innerHTML="‚ù§Ô∏è");

  answerButtons.forEach((btn,i)=>{
    btn.textContent=q.a[i];
    btn.className="answer-btn";
    btn.disabled=false;
  });

  updateScoreDisplay();
}

answerButtons.forEach((btn,i)=>btn.addEventListener("click", ()=>{
  const q = quiz[currentQuestion];
  answerButtons.forEach(b=>b.disabled=true);

  if(i===q.correct){
    btn.classList.add("correct");
    feedback.textContent="Richtig ‚úÖ";
    const e = rightEmojis[Math.floor(Math.random()*rightEmojis.length)];
    heart.textContent=e;
    bgHearts.forEach(h=>h.innerHTML=e);
    card.style.borderColor="#4CAF50";
    mcScore++;
    updateScoreDisplay();
  }else{
    btn.classList.add("wrong");
    answerButtons[q.correct].classList.add("correct");
    feedback.textContent="Falsch ‚ùå";
    const e = wrongEmojis[Math.floor(Math.random()*wrongEmojis.length)];
    heart.textContent=e;
    heart.style.animation="";
    bgHearts.forEach(h=>h.innerHTML=e);
    card.style.borderColor="#c62828";
    updateScoreDisplay();
  }
  nextBtn.style.display="block";
}));

nextBtn.addEventListener("click", ()=>{
  currentQuestion++;
  if(currentQuestion>=quiz.length){
    quizContainer.style.display="none";
    document.getElementById("chapter2-container").style.display="flex";
    updateScoreDisplay();
    startChapter2();
  }else{
    showQuestion();
  }
});// ======================
// Kapitel 2 (L√ºckentext)
// ======================
const chapter2Text=`Das sauerstoffarme Blut aus dem K√∂rper flie√üt √ºber die *obere Hohlvene* und die *untere Hohlvene* in den *rechten Vorhof*. 
Hier √∂ffnet sich die *Trikuspidalklappe*, sodass das Blut in die *rechte Herzkammer* flie√üen kann.
Bei der Kontraktion der rechten Kammer schlie√üt sich die *Trikuspidalklappe* und die *Pulmonalklappe* √∂ffnet sich, damit kein Blut zur√ºck in den Vorhof flie√üt. 
Das Blut wird in die *Pulmonalarterie* gepumpt und zur *Lunge* transportiert.
In den *Lungenkapillaren* gibt das Blut *Kohlendioxid* ab und nimmt *Sauerstoff* auf.
Das nun sauerstoffreiche Blut flie√üt √ºber die *Lungenvenen* zur√ºck in den *linken Vorhof*. 
Die *Mitralklappe* √∂ffnet sich, und das Blut str√∂mt in die *linke Herzkammer*.
Bei der Kontraktion der linken Kammer √∂ffnet sich die *Aortenklappe*, und das sauerstoffreiche Blut wird in die *Aorta* gepumpt und gelangt in den *K√∂rperkreislauf*.`;

const luecken = chapter2Text.match(/\*([^\*]+)\*/g).map(e=>e.replace(/\*/g,''));
const chapter2TextHTML = chapter2Text.replace(/\*([^\*]+)\*/g,'<span class="luecke" data-word="$1"></span>');
const wordItems = luecken.map((w, i) => ({ id: i, word: w, used: false }));

function startChapter2(){
  const container=document.getElementById("chapter2-text");
  container.innerHTML=chapter2TextHTML;

  const bank=document.getElementById("wordbank");
  const feedbackEl=document.getElementById("chapter2-feedback");
  const nextBtn=document.getElementById("chapter2-next-btn");
  const resetBtn=document.getElementById("reset-btn");

  let selectedId = null;

  // ‚úÖ W√∂rterbank gemischt, bleibt stabil
  const order = shuffle(wordItems.map(it => it.id));

  // ‚úÖ Zustand
  let graded = false;

  function renderBank(){
    bank.innerHTML = "";
    order.forEach(id=>{
      const item = wordItems[id];
      if(item.used) return;

      const span=document.createElement("span");
      span.textContent=item.word;
      if(selectedId === item.id) span.classList.add("selected");
      if(graded) span.classList.add("disabled");

      span.addEventListener("click", ()=>{
        if(graded) return;
        selectedId = item.id;
        renderBank();
      });

      bank.appendChild(span);
    });
  }
  renderBank();

  function lockChapter2(){
    bank.querySelectorAll("span").forEach(s=>s.classList.add("disabled"));
    resetBtn.disabled = true;
    resetBtn.style.opacity = "0.5";
    resetBtn.style.cursor = "default";

    container.querySelectorAll(".luecke").forEach(l=>{
      l.classList.add("locked");
      l.style.pointerEvents = "none";
    });
  }

  container.querySelectorAll(".luecke").forEach(l=>{
    l.addEventListener("click", ()=>{
      if(graded) return;
      if(selectedId === null) return;

      const prevId = l.dataset.filledId;
      if(prevId !== undefined && prevId !== ""){
        const prevItem = wordItems[Number(prevId)];
        if(prevItem) prevItem.used = false;
      }

      const item = wordItems[selectedId];
      l.textContent = item.word;
      l.dataset.filledId = String(item.id);
      item.used = true;

      selectedId = null;
      renderBank();
    });
  });

  resetBtn.onclick = () => {
    if(graded) return;
    selectedId = null;
    wordItems.forEach(it=>it.used=false);
    container.querySelectorAll(".luecke").forEach(l=>{
      l.textContent = "";
      l.dataset.filledId = "";
      l.classList.remove("good","bad","locked");
      l.style.pointerEvents = "";
    });
    feedbackEl.textContent = "";
    renderBank();
  };

  nextBtn.onclick = async () => {
    // 2. Klick: weiter zum Risikomodus
    if(graded){
      document.getElementById("chapter2-container").style.display="none";
      updateScoreDisplay();
      showRiskEntry();
      return;
    }

    // 1. Klick: auswerten + markieren
    graded = true;
    lueckenScore = 0;

    const blanks = Array.from(container.querySelectorAll(".luecke"));

    // obere/untere Hohlvene d√ºrfen getauscht werden
    const venaOber = blanks.find(b => b.dataset.word === "obere Hohlvene");
    const venaUnter = blanks.find(b => b.dataset.word === "untere Hohlvene");
    const need = new Set(["obere Hohlvene","untere Hohlvene"]);

    let venaHandled = false;
    if (venaOber && venaUnter) {
      const a = (venaOber.textContent || "").trim();
      const b = (venaUnter.textContent || "").trim();
      if (need.has(a) && need.has(b) && a !== "" && b !== "" && a !== b) {
        lueckenScore += 2;
        venaHandled = true;
        venaOber.classList.add("good");
        venaUnter.classList.add("good");
      }
    }

    blanks.forEach(l=>{
      const expected = l.dataset.word;
      const filled = (l.textContent || "").trim();

      if (venaHandled && (expected === "obere Hohlvene" || expected === "untere Hohlvene")) return;

      if(filled === expected){
        lueckenScore++;
        l.classList.add("good");
      }else{
        l.classList.add("bad");
        l.title = "Richtig w√§re: " + expected;
      }
    });

    // ‚úÖ Basis = (MC + L√ºcken) * 10
    baseScore = (mcScore + lueckenScore) * 10;
    updateScoreDisplay();

    lockChapter2();
    feedbackEl.textContent = `Auswertung fertig ‚úÖ Du hast im L√ºckentext ${lueckenScore} Punkte. (Basis: ${baseScore})`;
    nextBtn.textContent = "Weiter";
    renderBank();
  };
}

// ======================
// Kapitel 3: Risikomodus
// ======================
const riskEntry = document.getElementById("risk-entry");
const riskContainer = document.getElementById("risk-container");
const riskStartBtn = document.getElementById("risk-start-btn");
const riskSkipBtn = document.getElementById("risk-skip-btn");

const riskBasePill = document.getElementById("riskBasePill");
const riskPotPill  = document.getElementById("riskPotPill");
const riskLevelPill= document.getElementById("riskLevelPill");
const riskTimerPill= document.getElementById("riskTimerPill");
const riskLevelTitle = document.getElementById("riskLevelTitle");
const riskArea = document.getElementById("riskArea");
const riskActionBtn = document.getElementById("risk-action-btn");
const riskCashoutBtn = document.getElementById("risk-cashout-btn");
const riskNote = document.getElementById("risk-note");

let riskLevel = 1;
const riskMaxLevel = 6;

// Rewards bleiben so
const riskRewards = [20,20,40,80,160,320];

// Zeitlimits wie von dir festgelegt: Lv1 90s, Lv2 90s, Lv3 60s, Lv4 60s, Lv5 30s, Lv6 200s
const riskTimeLimits = [90,90,60,60,30,200];

let riskTimer = null;
let riskTimeLeft = 0;

// State + Buchstabensalat-Timer
let levelState = {};
let bsTimers = [];
let bsLastMinuteTriggered = false;

const levelInfo = {
  1: { title: "Zuordnen", desc: "Tippen um Deutsch mit Latein zu verbinden.<br>Nach jedem verbundenen Paar auf ‚Äûpr√ºfen‚Äú klicken um das Paar einzuloggen." },
  2: { title: "Chips", desc: "Setze 4 Begriffe korrekt in 4 L√ºcken (erst L√ºcke, dann Chip)." },
  3: { title: "Reihenfolge", desc: "Sortiere einen Blutfluss-Ausschnitt in die richtige Reihenfolge." },
  4: { title: "Wahr/Falsch", desc: "Bewerte alle 6 Aussagen." },
  5: { title: "Falsche Aussage", desc: "W√§hle die eine falsche Aussage aus mehreren Optionen." },
  6: { title: "Buchstabensalat", desc: "Setze den gesuchten Begriff zusammen. Nicht alle Buchstaben geh√∂ren zum Wort." }
};

function clearBuchstabenTimers(){
  bsTimers.forEach(t=>clearTimeout(t));
  bsTimers = [];
  bsLastMinuteTriggered = false;
}

function setOrangeMood(){
  heart.textContent="üé≤";
  bgHearts.forEach(h=>h.innerHTML="üé≤");
  card.style.borderColor="#FF9800";
  heart.style.animation="pulse 1s infinite";
}

function updateRiskHUD(){
  riskBasePill.textContent = `Basis: ${baseScore}`;
  riskPotPill.textContent  = `Risiko-Topf: ${riskScore}`;
  riskLevelPill.textContent= `Level: ${riskLevel}/${riskMaxLevel}`;
  riskTimerPill.textContent= `‚è±Ô∏è ${Math.max(0, riskTimeLeft)}s`;
  riskLevelTitle.textContent = `Level ${riskLevel} ‚Üí +${riskRewards[riskLevel-1]} Punkte`;
}

function stopRiskTimer(){
  if(riskTimer){
    clearInterval(riskTimer);
    riskTimer = null;
  }
}

function startRiskTimer(seconds){
  stopRiskTimer();
  riskTimeLeft = seconds;
  updateRiskHUD();
  riskTimer = setInterval(()=>{
    riskTimeLeft--;

    // Level 6: "letzte Minute" triggern
    if(riskLevel === 6 && !bsLastMinuteTriggered && riskTimeLeft <= 60){
      bsLastMinuteTriggered = true;
      try{ window.__bsTriggerLastMinute && window.__bsTriggerLastMinute(); }catch(e){}
    }

    updateRiskHUD();

    if(riskTimeLeft <= 0){
      stopRiskTimer();
      clearBuchstabenTimers();
      failRisk("Zeit abgelaufen ‚è±Ô∏è Risiko-Topf = 0.");
    }
  }, 1000);
}

function showRiskEntry(){
  riskScore = 0;
  riskLevel = 1;
  stopRiskTimer();
  clearBuchstabenTimers();
  riskTimeLeft = 0;

  setOrangeMood();
  riskEntry.style.display="flex";
  riskContainer.style.display="none";
  document.getElementById("risk-entry-note").textContent = `Deine Basis ist ${baseScore} Punkte. Risikopunkte kommen oben drauf.`;

  // ‚úÖ Scoreboard bleibt bis hier sichtbar
  updateScoreDisplay();
}

riskSkipBtn.addEventListener("click", async ()=>{
  riskScore = 0;
  finalScore = baseScore;
  await finalizeAndShowRanking();
});

riskStartBtn.addEventListener("click", ()=>{
  riskEntry.style.display="none";
  riskContainer.style.display="flex";
  startRiskLevel(1);
});

riskCashoutBtn.addEventListener("click", async ()=>{
  stopRiskTimer();
  clearBuchstabenTimers();
  finalScore = baseScore + riskScore;
  await finalizeAndShowRanking();
});

function failRisk(msg){
  riskScore = 0;
  updateRiskHUD();
  riskNote.textContent = msg + " Weiter geht's zur Rangliste‚Ä¶";
  setTimeout(async ()=>{
    finalScore = baseScore + riskScore;
    await finalizeAndShowRanking();
  }, 850);
}

function passRiskLevel(){
  const reward = riskRewards[riskLevel-1] || 0;
  riskScore += reward;

  riskNote.textContent = `Geschafft ‚úÖ +${reward} Risikopunkte!`;
  stopRiskTimer();
  clearBuchstabenTimers();

  setTimeout(()=>{
    if(riskLevel >= riskMaxLevel){
      (async ()=>{
        finalScore = baseScore + riskScore;
        await finalizeAndShowRanking();
      })();
      return;
    }
    riskLevel++;
    startRiskLevel(riskLevel);
  }, 700);
}

function startRiskLevel(level){
  levelState = {};
  riskNote.textContent = "";
  setOrangeMood();
  clearBuchstabenTimers();

  riskTimeLeft = riskTimeLimits[level-1] || 60;
  updateRiskHUD();

  const info = levelInfo[level] || { title:"", desc:"" };
  const reward = riskRewards[level-1] || 0;

  const isLevel6 = (level === 6);
  const isLevel4 = (level === 4);

  const extraHints = isLevel6
    ? `<div style="margin-top:8px;color:#ffb3b3;">Hinweise: nach <b>30s</b>, nach <b>60s</b> und <b>in der letzten Minute</b>.</div>`
    : ``;

  const extraLoginNote = isLevel4
    ? `<div style="margin-top:8px;color:#ffb3b3;"><b>Erst pr√ºfen, wenn alles eingeloggt ist.</b></div>`
    : ``;

  riskArea.innerHTML = `
    <div class="risk-box">
      <div class="risk-title">Level ${level}: ${info.title}</div>
      ${isLevel6 ? `<div style="color:#ffb3b3;font-weight:bold;margin-top:-2px;">(sehr schwer!)</div>` : ``}
      <div class="risk-small" style="margin-top:8px;">
        ${info.desc}
        ${extraHints}
        ${extraLoginNote}
        <br><br>
        ‚úÖ <b>Gewinn:</b> +${reward} Risikopunkte<br>
        ‚ùå <b>Niederlage:</b> Risiko-Topf wird <b>0</b> und du gehst zur Rangliste<br>
        ‚è±Ô∏è <b>Zeitlimit:</b> ${riskTimeLeft} Sekunden
        <br><br>
        <b>Willst du Level ${level} betreten?</b>
      </div>
    </div>
  `;

  riskCashoutBtn.style.display = "inline-block";
  riskActionBtn.textContent = `Level ${level} betreten`;
  riskActionBtn.onclick = ()=> beginRiskLevel(level);
}

function beginRiskLevel(level){
  levelState = {};
  riskNote.textContent = "";
  setOrangeMood();
  clearBuchstabenTimers();

  riskCashoutBtn.style.display = "none";
  startRiskTimer(riskTimeLimits[level-1] || 60);

  if(level === 1) renderLevel1_Match();
  if(level === 2) renderLevel2_Chips();
  if(level === 3) renderLevel3_Order();
  if(level === 4) renderLevel4_TrueFalse6();
  if(level === 5) renderLevel5_FindWrong9();
  if(level === 6) renderLevel6_Buchstabensalat();
}// ======================
// LEVEL 1: Match (Intro minimal, Level selbst nur Satz 2)
// ======================
function renderLevel1_Match(){
  riskActionBtn.textContent = "Pr√ºfen";

  const pairs = [
    {de:"Brustbein", la:"Sternum"},
    {de:"Rippe", la:"Costa"},
    {de:"Herzbeutel", la:"Perikard"},
    {de:"linker Vorhof", la:"Atrium sinistrum"},
    {de:"rechte Kammer", la:"Ventriculus dexter"},
  ];

  const left = shuffle(pairs.map(p=>p.de));
  const right = shuffle(pairs.map(p=>p.la));

  levelState.leftSel = null;
  levelState.rightSel = null;
  levelState.matched = new Set();

  riskArea.innerHTML = `
    <div class="risk-small">
      Nach jedem verbundenen Paar auf ‚Äûpr√ºfen‚Äú klicken um das Paar einzuloggen.
    </div>
    <div class="risk-grid">
      <div class="match-col" id="match-left"></div>
      <div class="match-col" id="match-right"></div>
    </div>
  `;

  const leftCol = document.getElementById("match-left");
  const rightCol = document.getElementById("match-right");

  function renderCols(){
    leftCol.innerHTML = "";
    rightCol.innerHTML = "";

    left.forEach(text=>{
      const done = Array.from(levelState.matched).some(k=>k.split("|")[0]===text);
      const div = document.createElement("div");
      div.className = "match-item" + (done ? " done" : "") + (levelState.leftSel === text ? " selected" : "");
      div.textContent = text;
      div.onclick = ()=>{
        if(done) return;
        levelState.leftSel = (levelState.leftSel === text) ? null : text;
        renderCols();
      };
      leftCol.appendChild(div);
    });

    right.forEach(text=>{
      const done = Array.from(levelState.matched).some(k=>k.split("|")[1]===text);
      const div = document.createElement("div");
      div.className = "match-item" + (done ? " done" : "") + (levelState.rightSel === text ? " selected" : "");
      div.textContent = text;
      div.onclick = ()=>{
        if(done) return;
        levelState.rightSel = (levelState.rightSel === text) ? null : text;
        renderCols();
      };
      rightCol.appendChild(div);
    });
  }
  renderCols();

  riskActionBtn.onclick = ()=>{
    if(!levelState.leftSel || !levelState.rightSel){
      riskNote.textContent = "W√§hle links und rechts je ein Feld.";
      return;
    }

    const de = levelState.leftSel;
    const la = levelState.rightSel;
    const ok = pairs.some(p=>p.de===de && p.la===la);

    if(ok){
      levelState.matched.add(`${de}|${la}`);
      levelState.leftSel = null;
      levelState.rightSel = null;
      riskNote.textContent = "Richtig ‚úÖ";
      renderCols();
      if(levelState.matched.size === 5) passRiskLevel();
    }else{
      failRisk("Falsche Zuordnung ‚ùå");
    }
  };
}

// ======================
// LEVEL 2: Chips (4 L√ºcken + nur 1 Fake)
// ======================
function renderLevel2_Chips(){
  riskActionBtn.textContent = "Pr√ºfen";

  const blanks = [
    {key:"b1", label:"1)", text:"‚Ä¶ ist eine Segelklappe zwischen rechtem Vorhof und rechter Kammer.", answer:"Trikuspidalklappe"},
    {key:"b2", label:"2)", text:"‚Ä¶ ist eine Taschenklappe zwischen linker Kammer und Aorta.", answer:"Aortenklappe"},
    {key:"b3", label:"3)", text:"‚Ä¶ ist die Segelklappe zwischen linkem Vorhof und linker Kammer.", answer:"Mitralklappe"},
    {key:"b4", label:"4)", text:"‚Ä¶ ist die Taschenklappe zwischen rechter Kammer und Lungenarterie.", answer:"Pulmonalklappe"}
  ];

  const chips = shuffle(["Trikuspidalklappe","Aortenklappe","Mitralklappe","Pulmonalklappe","Sinusknoten"]); // 1 Fake

  levelState.filled = { b1:"", b2:"", b3:"", b4:"" };
  levelState.activeBlank = null;

  riskArea.innerHTML = `
    <div class="risk-small">Erst L√ºcke ausw√§hlen, dann Chip anklicken.</div>
    <div class="risk-box" style="margin-top:10px;" id="chipsBox"></div>
    <div class="letters-wrap" id="chipsWrap" style="margin-top:12px;"></div>
  `;

  const box = document.getElementById("chipsBox");
  const wrap = document.getElementById("chipsWrap");

  function makeBlankRow(b){
    const row = document.createElement("div");
    row.style.marginBottom = "12px";
    row.innerHTML = `
      <div style="color:#aaa;font-size:13px;margin-bottom:6px;">${b.label}</div>
      <span class="luecke" id="blank_${b.key}" style="min-width:240px; text-align:center;">${b.label} L√ºcke</span>
      <div style="margin-top:6px;color:#ccc;font-size:13px;">${b.text}</div>
    `;
    box.appendChild(row);
  }

  blanks.forEach(makeBlankRow);

  const blankEls = {};
  blanks.forEach(b => blankEls[b.key] = document.getElementById(`blank_${b.key}`));

  function setActive(key){
    levelState.activeBlank = key;
    Object.values(blankEls).forEach(el=>{
      el.style.outline = "none";
      el.style.background = "#111";
      el.style.borderColor = "#c62828";
    });
    const el = blankEls[key];
    el.style.outline = "2px solid #4CAF50";
    el.style.background = "#0f1b12";
  }

  blanks.forEach(b=>{
    blankEls[b.key].onclick = ()=>setActive(b.key);
  });

  chips.forEach(ch=>{
    const btn = document.createElement("button");
    btn.className = "letter-btn";
    btn.textContent = ch;
    btn.onclick = ()=>{
      if(!levelState.activeBlank){ riskNote.textContent = "Erst eine L√ºcke ausw√§hlen."; return; }
      const key = levelState.activeBlank;
      levelState.filled[key] = ch;
      const el = blankEls[key];
      el.textContent = ch;
      el.classList.remove("good","bad");
      riskNote.textContent = "";
    };
    wrap.appendChild(btn);
  });

  riskActionBtn.onclick = ()=>{
    let allOk = true;

    blanks.forEach(b=>{
      const filled = (levelState.filled[b.key] || "").trim();
      const ok = filled === b.answer;
      allOk = allOk && ok;
      blankEls[b.key].classList.toggle("good", ok);
      blankEls[b.key].classList.toggle("bad", !ok);
    });

    if(allOk) passRiskLevel();
    else failRisk("Mindestens eine L√ºcke falsch ‚ùå");
  };
}

// ======================
// LEVEL 3: Reihenfolge
// ======================
function renderLevel3_Order(){
  riskActionBtn.textContent = "Pr√ºfen";

  const correct = ["Rechter Vorhof","Rechte Kammer","Pulmonalarterie","Lunge","Linker Vorhof"];
  const options = shuffle(correct.slice());
  levelState.correct = correct;
  levelState.selects = [];

  riskArea.innerHTML = `
    <div class="risk-small">Bringe den Blutfluss (Ausschnitt) in die richtige Reihenfolge.</div>
    <div class="order-list" id="orderList"></div>
  `;
  const list = document.getElementById("orderList");

  correct.forEach((_, idx)=>{
    const row = document.createElement("div");
    row.className = "order-row";
    row.innerHTML = `<div style="width:20px;color:#aaa">${idx+1}.</div>`;
    const sel = document.createElement("select");
    sel.innerHTML = `<option value="">-- ausw√§hlen --</option>` + options.map(o=>`<option value="${o}">${o}</option>`).join("");
    row.appendChild(sel);
    list.appendChild(row);
    levelState.selects.push(sel);
  });

  riskActionBtn.onclick = ()=>{
    const chosen = levelState.selects.map(s=>s.value);
    if(chosen.some(v=>!v)){ riskNote.textContent = "Bitte alle Felder ausw√§hlen."; return; }
    const ok = chosen.every((v,i)=> v === levelState.correct[i]);
    if(ok) passRiskLevel(); else failRisk("Reihenfolge falsch ‚ùå");
  };
}

// ======================
// LEVEL 4: Wahr/Falsch (6 Aussagen) + Hinweis ohne Klammern
// ======================
function renderLevel4_TrueFalse6(){
  riskActionBtn.textContent = "Pr√ºfen";

  const items = [
    {t:"Die Aortenklappe ist eine Taschenklappe.", ok:true},
    {t:"Die Lungenvenen f√ºhren sauerstoffarmes Blut zum Herzen.", ok:false},
    {t:"Der Sinusknoten gibt normalerweise den Herzrhythmus vor.", ok:true},
    {t:"Arterien f√ºhren Blut vom Herzen weg.", ok:true},
    {t:"Venen besitzen h√§ufig Klappen, um R√ºckfluss zu verhindern.", ok:true},
    {t:"Kapillaren sind gr√∂√üer als Arterien.", ok:false},
  ];
  levelState.answers = new Map();

  riskArea.innerHTML = `
    <div class="risk-small">
      Bewerte alle 6 Aussagen.<br>
      <b>Erst pr√ºfen, wenn alles eingeloggt ist.</b>
    </div>
    <div class="risk-box" id="tfBox"></div>
  `;
  const box = document.getElementById("tfBox");

  items.forEach((it, idx)=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "10px";
    wrap.innerHTML = `
      <div style="margin-bottom:6px">${idx+1}) ${it.t}</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn-secondary" data-idx="${idx}" data-val="true" style="padding:8px 12px;border-radius:14px;">Wahr</button>
        <button class="btn-secondary" data-idx="${idx}" data-val="false" style="padding:8px 12px;border-radius:14px;">Falsch</button>
      </div>
    `;
    box.appendChild(wrap);
  });

  box.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.idx);
      const val = btn.dataset.val === "true";
      levelState.answers.set(idx, val);

      const row = btn.parentElement;
      row.querySelectorAll("button").forEach(b=>{
        b.style.outline = "none";
        b.style.background = "#333";
      });
      btn.style.outline = "2px solid #4CAF50";
      btn.style.background = "#1d2b1f";
    });
  });

  riskActionBtn.onclick = ()=>{
    if(levelState.answers.size !== items.length){
      riskNote.textContent = "Bitte alle 6 Aussagen bewerten.";
      return;
    }
    const ok = items.every((it, idx)=> levelState.answers.get(idx) === it.ok);
    if(ok) passRiskLevel(); else failRisk("Mindestens eine Aussage falsch ‚ùå");
  };
}

// ======================
// LEVEL 5: Falsche Aussage (9 Optionen) ‚úÖ Aussage korrigiert
// ======================
function renderLevel5_FindWrong9(){
  riskActionBtn.textContent = "Best√§tigen";

  const truths = [
    "Die Mitralklappe liegt zwischen linkem Vorhof und linker Kammer.",
    "Die Aorta transportiert Blut in den K√∂rperkreislauf.",
    "Kapillaren sind die kleinsten Blutgef√§√üe.",
    "Der Sinusknoten liegt im rechten Vorhof.",
    "Die Pulmonalklappe verhindert R√ºckfluss in die rechte Kammer.",
    "Arterien haben im Vergleich zu Venen meist dickere W√§nde.",
    "Das Septum trennt die rechte und linke Herzh√§lfte.",
    "Die Lungenarterie f√ºhrt sauerstoffarmes Blut zur Lunge."
  ];

  // ‚úÖ wirklich falsche Aussage
  const wrong = "Die linke Herzkammer pumpt das sauerstoffarme Blut zur Lunge.";

  const options = truths.concat([wrong]);
  levelState.pick = null;

  riskArea.innerHTML = `
    <div class="risk-small">W√§hle die <b>falsche</b> Aussage.</div>
    <div class="answers-wrap" id="fwWrap" style="margin-top:10px;"></div>
  `;
  const wrap = document.getElementById("fwWrap");

  options.forEach((t, idx)=>{
    const b = document.createElement("button");
    b.className = "answer-btn";
    b.textContent = t;
    b.onclick = ()=>{
      levelState.pick = idx;
      wrap.querySelectorAll("button").forEach(x=>x.classList.remove("correct","wrong"));
      b.classList.add("correct");
    };
    wrap.appendChild(b);
  });

  riskActionBtn.onclick = ()=>{
    if(levelState.pick === null){ riskNote.textContent = "Bitte eine Aussage ausw√§hlen."; return; }
    const pickedText = options[levelState.pick];
    if(pickedText === wrong) passRiskLevel();
    else failRisk("Das war nicht die falsche Aussage ‚ùå");
  };
}

// ======================
// LEVEL 6: Buchstabensalat (Hinweise untereinander + Tasten bleiben, verschwinden als L√ºcke)
// ======================
function renderLevel6_Buchstabensalat(){
  riskActionBtn.textContent = "Pr√ºfen";

  const target = "LUNGENKREISLAUF";
  const targetLetters = target.split("");
  const requiredCounts = {};
  targetLetters.forEach(ch=> requiredCounts[ch] = (requiredCounts[ch]||0)+1);

  // Decoys + Pool
  const decoys = shuffle(["A","E","I","O","U","R","S","T","N","K","F","M","D","B","Z","H"]).slice(0,9);
  const pool = shuffle(targetLetters.concat(decoys));

  levelState.target = target;
  levelState.current = "";
  levelState.stack = [];

  riskArea.innerHTML = `
    <div class="risk-small">
      <b>Buchstabensalat:</b> Setze den gesuchten Begriff zusammen. Nicht alle Buchstaben geh√∂ren zum Wort.
      <div id="bsHints" style="margin-top:10px;color:#ff9e9e;line-height:1.35;">
        <div>1. Hinweis: <span id="h1"></span></div>
        <div>2. Hinweis: <span id="h2"></span></div>
        <div>3. Hinweis: <span id="h3"></span></div>
      </div>
    </div>
    <div class="letters-progress" id="bsProgress"></div>
    <div class="letters-wrap" id="bsWrap"></div>
    <div class="risk-actions" style="justify-content:flex-start;margin-top:10px;">
      <button id="bsBack" class="btn-secondary" style="padding:8px 12px;border-radius:14px;">‚å´ L√∂schen</button>
      <button id="bsClear" class="btn-secondary" style="padding:8px 12px;border-radius:14px;">‚Ü© Reset</button>
    </div>
  `;

  const h1 = document.getElementById("h1");
  const h2 = document.getElementById("h2");
  const h3 = document.getElementById("h3");

  const progress = document.getElementById("bsProgress");
  const wrap = document.getElementById("bsWrap");
  const back = document.getElementById("bsBack");
  const clear = document.getElementById("bsClear");

  function renderProgress(){
    progress.textContent = levelState.current || "(noch leer)";
  }
  renderProgress();

  const allButtons = [];

  function vanish(btn){
    if(!btn) return;
    btn.disabled = true;
    btn.classList.add("vanish"); // bleibt als L√ºcke
  }

  function lastMinuteHideFalseLetters(){
    // erst alle, die gar nicht im Ziel vorkommen
    allButtons.forEach(({ch, btn})=>{
      if(!requiredCounts[ch]) vanish(btn);
    });

    // dann √úberh√§nge (zu viele von einem Buchstaben) entfernen
    const visibleByChar = {};
    allButtons.forEach(({ch, btn})=>{
      if(btn.classList.contains("vanish")) return;
      visibleByChar[ch] = visibleByChar[ch] || [];
      visibleByChar[ch].push(btn);
    });

    // zus√§tzlich: E, K, I, U rausnehmen (wie gew√ºnscht), falls zu viele sichtbar
    ["E","K","I","U"].forEach(ch=>{
      const list = visibleByChar[ch] || [];
      const req = requiredCounts[ch] || 0;
      while(list.length > req){
        vanish(list[list.length-1]);
        list.pop();
      }
    });

    // final: generisch reduzieren
    Object.keys(visibleByChar).forEach(ch=>{
      const req = requiredCounts[ch] || 0;
      const list = visibleByChar[ch] || [];
      while(list.length > req){
        vanish(list[list.length-1]);
        list.pop();
      }
    });
  }

  window.__bsTriggerLastMinute = ()=>{
    h3.textContent = "Alle falschen Buchstaben verschwinden.";
    lastMinuteHideFalseLetters();
  };

  // Hinweis 1 nach 30s
  bsTimers.push(setTimeout(()=>{
    if(riskLevel === 6 && riskTimer){ h1.textContent = `Das Wort hat ${target.length} Buchstaben.`; }
  }, 30000));

  // Hinweis 2 nach 60s
  bsTimers.push(setTimeout(()=>{
    if(riskLevel === 6 && riskTimer){ h2.textContent = "Es ist ein deutsches Wort. Kein Latein."; }
  }, 60000));

  // Buttons
  pool.forEach(ch=>{
    const btn = document.createElement("button");
    btn.className = "letter-btn";
    btn.textContent = ch;

    btn.onclick = ()=>{
      btn.disabled = true;
      btn.classList.add("used");
      levelState.current += ch;
      levelState.stack.push({ ch, btn });
      renderProgress();
    };

    wrap.appendChild(btn);
    allButtons.push({ ch, btn });
  });

  back.onclick = ()=>{
    if(levelState.stack.length === 0) return;
    const last = levelState.stack.pop();
    levelState.current = levelState.current.slice(0, -1);

    // nur reaktivieren, wenn nicht "vanish"
    if(last && last.btn && !last.btn.classList.contains("vanish")){
      last.btn.disabled = false;
      last.btn.classList.remove("used");
    }
    renderProgress();
  };

  clear.onclick = ()=>{
    levelState.stack.forEach(x=>{
      if(x.btn && !x.btn.classList.contains("vanish")){
        x.btn.disabled = false;
        x.btn.classList.remove("used");
      }
    });
    levelState.stack = [];
    levelState.current = "";
    renderProgress();
  };

  riskActionBtn.onclick = ()=>{
    const guess = (levelState.current || "").trim().toUpperCase();
    if(!guess){ riskNote.textContent = "Du musst erst Buchstaben anklicken."; return; }
    if(guess === levelState.target) passRiskLevel();
    else failRisk("Falsches Wort ‚ùå");
  };
}

// ======================
// Finale: Speichern + Rangliste
// ======================
async function finalizeAndShowRanking(){
  stopRiskTimer();
  clearBuchstabenTimers();
  try{ window.__bsTriggerLastMinute = null; }catch(e){}

  // ‚úÖ Scoreboard ausblenden auf Rangliste
  hideScoreboard();

  riskEntry.style.display = "none";
  riskContainer.style.display = "none";
  document.getElementById("chapter2-container").style.display = "none";
  document.getElementById("result-page").style.display="flex";

  heart.textContent="üèÜ";
  bgHearts.forEach(h=>h.innerHTML="üèÜ");
  card.style.borderColor="#FF9800";
  heart.style.animation="pulse 1s infinite";

  if(!savedOnce){
    savedOnce = true;
    const rawName = localStorage.getItem("playerName") || "Unbekannt";
    const safeName = normalizeSpaces(rawName);
    try{
      await saveScoreToFirestore(safeName, finalScore);
    }catch(e){
      console.log("Firestore Save Error:", e);
      alert("Konnte nicht speichern (Firestore). Pr√ºfe Internet & Firestore-Regeln.");
    }
  }

  await renderRanking();
}
</script>
</body>
</html>
